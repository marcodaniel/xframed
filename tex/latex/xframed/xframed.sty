%%
%% This is file `xframed.sty',
%% ----------------------------------------------------------------
%% 
%% Author's name: Marco Daniel
%% License type: lppl
%% 
%% ===========================================================
%% ===== Currently the package has a pre-pre-alpha-status ====
%% ===========================================================
%% 
%%  Copyright (c) 2013 Marco Daniel
%% 
\def\xframedversion{v0.01 ALPHA}
\RequirePackage{expl3}
\GetIdInfo$Id: xframed.dtx 13 2012-06-08 14:11:22Z marco $
          {package xframed}

\ProvidesExplPackage{\ExplFileName}
     {\ExplFileDate}{\ExplFileVersion}{\ExplFileDescription}

\cs_set_eq:NN \xframedpackagename \ExplFileName

%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%
\@ifpackagelater { expl3 } { 2011/09/05 }
  { }
  {
    \PackageError { xframed } { Support~package~expl3~too~old. }
      {
        You~need~to~update~your~installation~of~the~bundles~'l3kernel'~and~
        'l3packages'.\\
        Loading~xframed~will~abort!
      }
    \tex_endinput:D
  }
%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%
\ExplSyntaxOff
 \RequirePackage{tikz}
 \usetikzlibrary{backgrounds,shadows,calc,positioning,shapes.misc}
\ExplSyntaxOn

\RequirePackage{longtable}%needed to display developer Info
\RequirePackage{etoolbox}%as long as regexpatch has alpha status
%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%
\cs_new_protected:Npn \xframed__load_check:n #1 {
    \IfFileExists {#1.sty}
      { \RequirePackage{#1} }
      { \msg_error:nnx { xframed } { package-not-available } {#1} }
}

\clist_map_function:nN
  { zref-abspage , xparse , l3keys2e  }
    \xframed__load_check:n

\cs_new_protected:Npn \xframed__load_deffiles:n #1 {
    \IfFileExists {xframed-#1.def}
      { \input{xframed-#1.def} }
      { \msg_error:nnx { xframed } { def-not-available } {#1} }
}
\msg_new:nnnn { xframed } { def-not-available }
  { File~xframed-'#1'.def~is~not~available. }
  {
    The~file~xframed-#1-.def~is~not available\\
    but~xframed~needs~the~file~.\\
    I~guess~you~installed~xframed~wrong.
  }

%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%
%!input all new variables
\xframed__load_deffiles:n { initial }
%!input helper functions
\xframed__load_deffiles:n { funct }
%!input messages
\xframed__load_deffiles:n { msg }
%!input user keys
\xframed__load_deffiles:n { keys }
%!input title-foot-coffin-setup
\xframed__load_deffiles:n { titlefoot }
%!input split
\xframed__load_deffiles:n { split }
%!input listings
\xframed__load_deffiles:n { listings }
%!input minted
\xframed__load_deffiles:n { minted }
%!input theorem
\xframed__load_deffiles:n { theorem }
%!input drawing method tikz
\xframed__load_deffiles:n { tikz }
%!input user commands
\xframed__load_deffiles:n { user }
%!input listings -- later, much later
%\xframed__load_deffiles:n { mdframed }
%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%
\xframed__developer_tools:
%%============================================%%
%%============================================%%
%%============================================%%
%%============================================%%



% Define user environment

\NewDocumentEnvironment { xframed } { O{} }
 {
 \group_begin:
   \xframedsetup { #1 }
   \xframed__start_environment:n 
    { 
     \xframed__get_length:n
      {
       minimum-space
      }
    }
   \xframed__environment_precode:
    \vcoffin_set:Nnw   \l__xframed_main_coffin
                     { \l__xframed_coffin_width_dim }
     \xframed_prevent_firstindent:
     \xframed__environment_inner_precode:
     \xframed__inner_head:
 }
 {
    \xframed__environment_inner_postcode:
    \vcoffin_set_end:
  \xframed__set_list:
    \xframed__environment_postcode:
  \group_insert_after:N \xframed__set_endlist:
  \group_end:
 }

\cs_new:Nn \xframed_prevent_firstindent: 
 {
  \@afterindentfalse\@afterheading
 }

\cs_new:Nn \xframed__inner_head:
 {
    \tl_if_blank:VF \l__xframed_head_tl 
     {
     \group_begin:
       \tl_use:N \l__xframed_headprecode_tl
       \color
          {
           \xframed__get_color:n { head-font-color }
          }
       \tl_use:N \l__xframed_head_font_tl
       \tl_use:N \l__xframed_head_tl
       \tl_use:N \l__xframed_headpostcode_tl
     \group_end:
     }
 }


%%Not recommended
\cs_new_nopar:Npn \xframeddivide
 {
    \xframed__environment_head_postcode:
    \vcoffin_set_end:
    \coffin_set_eq:NN \l__xframed_head_coffin \l__xframed_main_coffin
    \bool_set_true:N \l__xframed_head_bool
    \vcoffin_set:Nnw   \l__xframed_main_coffin
                      { \l__xframed_coffin_width_dim }
     \xframed__environment_afterhead_precode:
 }

\cs_new:Npn \xframed__environment_afterhead_precode: {}

\cs_new:Npn \xframed__test_if_splittable: {}

\cs_new:Npn \xframed__environment_head_postcode: {}

\cs_new:Npn \xframed__environment_precode:
 {
  \xframed__developer_tools:
  \xframed__minimum_space:
  \xframed__test_if_splittable:
  \xframed__calculate_width:
  \xframed__declare_footnotes:
  \xframed__frame_linewidth:
  \tl_use:N \l__xframed_codebefore_tl
 }

\cs_new:Npn \xframed__minimum_space:
 {
  \group_begin:
    \dim_set:Nn \l_tmpa_dim
                { \xframed__get_length:n{ minimum-space } }
    \skip_vertical:n { \c_zero_dim plus \l_tmpa_dim }
    \tex_penalty:D  -100 \scan_stop:
    \skip_vertical:n { \c_zero_dim plus -\l_tmpa_dim }
    \skip_vertical:n { \l_tmpa_dim }
    \tex_penalty:D  9999 \scan_stop:
    \skip_vertical:n { -\l_tmpa_dim }
    \skip_vertical:n { 0pt plus 0pt minus 0pt }
  \group_end:
 }


\cs_new:Npn \xframed__calculate_width:
 {
  \dim_set:Nn \l__xframed_coffin_width_dim { \xframed__get_length:n { width } }
  \clist_map_inline:nn
    {
     margin-left , line-width-left ,  inner-margin-left , 
     inner-margin-right , line-width-right , margin-right
    }
    {
     \dim_sub:Nn \l__xframed_coffin_width_dim
           {
            \xframed__get_length:n { ##1 }
           }
    }
 }

 
\cs_new:Npn \xframed__declare_footnotes:
 {
  %% START
   \cs_set:Npn \@mpfn { mpfootnote }
  %% set the counter output
   \cs_set:Npn \thempfn { \thempfootnote }
  %%reset counter
   \int_set_eq:NN \c@mpfootnote \c_zero
  %%
   \cs_set_eq:NN \@footnotetext \@mpfootnotetext
 }

\cs_new:Npn \xframed__environment_inner_precode:
 {
  \skip_vertical:n { - \parskip }
  \tl_use:N \l__xframed_main_font_tl
  \color { \xframed__get_color:n { font-color } }
  \tl_use:N \l__xframed_codebegin_tl
 }

\cs_new:Npn \xframed__environment_inner_postcode:
 {
  \xframed__ignore_last_skip:
  \xframed__ignore_last_descenders:
  \tl_use:N \l__xframed_codeend_tl
 }

\cs_new:Npn \xframed__ignore_last_skip:
 {
  \bool_if:NT \l__xframed_ignore_lastskip_bool
   {
    \par \tex_unskip:D
    \skip_vertical:N \tex_lastskip:D
   }
 }

%% Question on TeX.SX leads to the code
%% http://tex.stackexchange.com/questions/47584/how-to-make-mdframed-ignore-descenders-in-last-line
%%at the moment I need the interface to LaTeX2e
\cs_new:Npn \xframed__ignore_last_descenders:
 {
  \bool_if:NT \l__xframed_descenders_bool
    {
%    \par\strut\par
%    \unskip\unskip\setbox0=\lastbox
%    \vspace*{\dimexpr\ht\strutbox-\baselineskip\relax}
    \par
    \strut
    \par \tex_unskip:D \tex_unskip:D
    \setbox0=\tex_lastbox:D
    \skip_vertical:n { 0.7 \tex_baselineskip:D - \tex_baselineskip:D }
    }
 }


\cs_new:Npn \xframed__environment_postcode:
 {
%  \xframed__check_title_first:
  \xframed_check_footnotes:
  \xframed__first_title:
  \xframed__last_foot:
  \xframed__coffin_output: 
  \tl_use:N \l__xframed_codeafter_tl
  \skip_vertical:n { - \parskip }
 }


\cs_new:Npn \xframed_check_footnotes:
 {
  \box_if_empty:NTF \@mpfootins
    {
     \xframed__msg_log:n { no~footnotes~presented }
    }
    {
    \xframed__msg_log:n { footnotes~are~found }
    %%Save the footnoterule inside a coffin
    \vcoffin_set:Nnn   \l__xframed_temp_coffin
                     { \l__xframed_coffin_width_dim   }
                     { 
                      \skip_vertical:n 
                          { 
                           \xframed__get_skip:n { footnote-distance }
                          }
                      \xframed_footnote_rule: 
                      \vbox_unpack_clear:N \@mpfootins
                     }
    %%Join main coffin with footnote-rule coffin
    \coffin_join:NnnNnnnn 
      \l__xframed_main_coffin {b}{l}
      \l__xframed_temp_coffin {t}{l}
      { 0pt }{ 0pt }
    %%reset structure of main coffin:
    \xframed__coffin_restructure:N   \l__xframed_main_coffin
    }
 }

\cs_new:Npn \xframed_footnote_rule:
 {
  \tex_kern:D \c_zero_skip
  \tex_hrule:D
    width   \xframed__get_length:n { footnote-line-length }
    height  \xframed__get_length:n { footnote-line-width }
   \scan_stop:
  \tex_kern:D 2.6 pt
 }
 
\cs_new:Nn \xframed__frame_linewidth:
 {
  \xframed__test_linewidth:nnn 
     { topline } { length } { line-width-top }
  \xframed__test_linewidth:nnn 
     { leftline } { length } { line-width-left }
  \xframed__test_linewidth:nnn 
     { rightline } { length } { line-width-right }
  \xframed__test_linewidth:nnn 
     { bottomline } { length } { line-width-bottom }
 }

 
\cs_new:Npn \xframed__coffin_output:
 {
  \xframed__coffin_restructure:N \l__xframed_temp_coffin 
  \xframed__coffin_restructure:N \l__xframed_main_coffin
  %Add vertical space to main coffin
  \vcoffin_set:Nnn   \l__xframed_main_coffin
                        { 
                         \l__xframed_coffin_width_dim
                        }
                        {
                         \skip_vertical:n {  \xframed__get_length:n { inner-top-margin } }
                         \box_use:N \l__xframed_main_coffin
                         \skip_vertical:n {  \xframed__get_length:n { inner-bottom-margin } }
                        } 
  \xframed__draw_tikz_frame:  %\l__xframed_main_coffin
%  \fbox{\xframed__display_coffins:N \l__xframed_head_coffin }
%  \par
%  \fbox{\xframed__display_coffins:N \l__xframed_main_coffin }
%%  \box_use:N \l__xframed_main_coffin
 }

\cs_new:Npn \xframed_needed_height:
 {
  \dim_set:Nn \l__xframed_computed_coffin_height_dim
          {
           \coffin_ht:N \l__xframed_main_coffin
           + 
           \coffin_dp:N \l__xframed_main_coffin
           +
           \coffin_ht:N \l__xframed_title_coffin
           + 
           \coffin_dp:N \l__xframed_title_coffin        
           +
           \coffin_ht:N \l__xframed_foot_coffin
           + 
           \coffin_dp:N \l__xframed_foot_coffin
          }
  \xframed__frame_linewidth:  
  \clist_map_inline:nn
    {
     extra-skip-above , line-width-top , line-width-bottom ,
     line-width-title , line-width-foot 
    }
    {
     \dim_add:Nn \l__xframed_computed_coffin_height_dim
           {
            \xframed__get_length:n { ##1 }
           }
    }
 }


\tex_endinput:D

%% 
%% ================================================================
%% Copyright (C) 2012 by Marco Daniel
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License (LPPL), either
%% version 1.3c of this license or (at your option) any later
%% version.  The latest version of this license is in the file:
%% 
%% http://www.latex-project.org/lppl.txt
%% 
%% This work is "maintained" (as per LPPL maintenance status) by
%% Marco Daniel.
%% 
%% Have fun!
%% 
%% ================================================================
%%
%% End of file `xframed.sty'.

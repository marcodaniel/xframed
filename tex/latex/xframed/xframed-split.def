%%=======================================================%%
%%=======================================================%%
%% xframed-split.def                                     %%
%%                                                       %%
%% file to define the algorithm to split xframed         %%
%% file is part of the package xframed                   %%
%%                                                       %%
%% Author's name: Marco Daniel                           %%
%% License type: lppl                                    %%
%%                                                       %%
%%  Copyright (c) 2013 Marco Daniel                      %%
%%                                                       %%
%%  This package may be distributed under the terms      %%
%%  of the LaTeX Project Public License, as described    %%
%%  in lppl.txt in the base LaTeX distribution.Either    %%
%%  version 1.0 or, at your option, any later version.   %%
%%=======================================================%%
%%=======================================================%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                      Starting Output of the frame                      %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%do the output related to the previous tests
%%if splittable or split needed
%% \l__xframed_allowbreaking_bool = true
%%if split need not or isn't needed
%% \l__xframed_allowbreaking_bool = false
\cs_new:Nn \xframed__output_and_draw:
 {
  \bool_if:NTF \l__xframed_allowbreaking_bool
   {%need~split
    \xframed__output_and_draw_aux:
   }     
   {%no~split
    \xframed_draw_frame:
   }
 }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                          Output of the frame                           %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% draw the frame and print the material
% all calculations are done at this point
\cs_new:Nn \xframed_draw_frame:
 {
  \int_case:nnn { \xframed__framemethode_int }
   {
    { 1 } { \xframed__draw_tikz_frame: }%tikz
    { 2 } { \xframed__draw_tikz_frame: }%default
    { 3 } { \xframed__draw_tikz_frame: }%pstricks
   }
   {
    \xframed__msg_log:n { xframed~undefined~style }%need a good warning
   }  
 }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                           Splitting allowed?                           %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%Test if xframed can be splitted
%% not possible if inside
%% minipage, parbox, float, boxes
\cs_new:Nn \xframed__test_if_splittable:
 {
  \bool_if:nTF
    {
      \if@minipage 1 \else 0 \fi             || %compatible to LaTeX2e
      \ifinner     1 \else 0 \fi             || %compatible to LaTeX2e
      \ifnum\@floatpenalty<0\relax  1 \else 0 \fi || %compatible to LaTeX2e
      \bool_if_p:N \l__xframed_allowbreaking_bool 
    }
    {
     \bool_if:NF \l__xframed_allowbreaking_bool 
       {
        \msg_warning:nn { xframed } { inside-box }
       }
     \xframed__msg_log:n { xframed~uses~nonsplittable~output }
     %%can't be splitted
   %  \xframed_use_nonsplittable_output:
     \bool_set_false:N \l__xframed_allowbreaking_bool 
    }
    {
     \xframed__msg_log:n { xframed~uses~splittable~output }
     %%can be splitted
    % \xframed_use_splittable_output:
     \bool_set_true:N \l__xframed_allowbreaking_bool 
    }
 }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                 Setup the different pars of the frame                  %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%must be used local!!!
\cs_new:Npn \xframed_setup_firstframe:
 {
  %bottom line required, otherwise bottomline 0pt.
  \bool_if:NF \l__xframed_draweveryline_bool 
   {
    \bool_if:NT \l__xframed_bottomline_bool
     {
      \xframed__prop_set:Nnn \l__xframed_length_option_prop 
           { line-width-bottom } { 0pt }
      \bool_set_false:N \l__xframed_bottomline_bool      
     }
   }
  %no last-foot -- only foot
  \tl_set_eq:NN \l__xframed_lastfoot_tl \l__xframed_foot_tl
  % \cs_set_eq:NN \xframed__last_foot: \xframed__foot:
  %no inner-bottom-margin -- instead split-skip-bottom
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { inner-bottom-margin } { \xframed__get_length:n { split-skip-bottom } }
  %no skip below
  \xframed__prop_set:Nnn \l__xframed_skip_option_prop 
       { skip-below } { 0 pt }
 }

%must be used local!!!
\cs_new:Npn \xframed_setup_middleframe:
 {
  %top/bottom line required, otherwise top/bottom line 0pt.
  \bool_if:NF \l__xframed_draweveryline_bool 
   {
    \bool_if:NT \l__xframed_bottomline_bool
     {
      \xframed__prop_set:Nnn \l__xframed_length_option_prop 
           { line-width-bottom } { 0pt }
      \bool_set_false:N \l__xframed_bottomline_bool      
     }
    \bool_if:NT \l__xframed_topline_bool
     {
      \xframed__prop_set:Nnn \l__xframed_length_option_prop 
           { line-width-top } { 0pt }
      \bool_set_false:N \l__xframed_topline_bool      
     }
   }
  %no extra skip above 
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { extra-skip-above } { 0 pt }   
  %no first-title -- only title
  \tl_set_eq:NN \l__xframed_firsttitle_tl \l__xframed_title_tl
  % \cs_set_eq:NN \xframed__first_title: \xframed__title:  
  %no last-foot -- only foot
  \tl_set_eq:NN \l__xframed_lastfoot_tl \l__xframed_foot_tl
  % \cs_set_eq:NN \xframed__last_foot: \xframed__foot:
  %no inner-top-margin -- instead split-skip-top
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { inner-top-margin } { \xframed__get_length:n { split-skip-top } }
  %no inner-bottom-margin -- instead split-skip-bottom
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { inner-bottom-margin } { \xframed__get_length:n { split-skip-bottom } }
  %no skip below
  \xframed__prop_set:Nnn \l__xframed_skip_option_prop 
       { skip-below } { 0 pt }
 }

%must be used local!!!
\cs_new:Npn \xframed_setup_lastframe:
 {
  %top line required, otherwise top line 0pt.
  \bool_if:NF \l__xframed_draweveryline_bool 
   {
    \bool_if:NT \l__xframed_topline_bool
     {
      \xframed__prop_set:Nnn \l__xframed_length_option_prop 
           { line-width-top } { 0pt }
      \bool_set_false:N \l__xframed_topline_bool      
     }
   }
  %no extra skip above 
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { extra-skip-above } { 0 pt }
  %no first-title -- only title
  \tl_set_eq:NN \l__xframed_firsttitle_tl \l__xframed_title_tl 
  % \cs_set_eq:NN \xframed__first_title: \xframed__title:   
  %no inner-top-margin -- instead split-skip-top
  \xframed__prop_set:Nnn \l__xframed_length_option_prop 
       { inner-top-margin } { \xframed__get_length:n { split-skip-top } }
 }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                    Test if split is in title of foot                   %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cs_set_eq:NN \xframed__setup_frame: \q_stop

\cs_new:Npn \xframed__dimtest_title_foot:
 {
  \dim_compare:nNnTF 
    { \vsize }
    <
    {
     \l__xframed_title_htdp_dim + \l__xframed_foot_htdp_dim      
     +
     \xframed__get_length:n { line-width-title }
     +
     \xframed__get_length:n { line-width-foot }
    }
    {%title+foot too big for one page -- error
     \xframed__msg_log:n { xframed~foot~title~too~big }%need a good warning     
    }
    {%we can work:
     \dim_compare:nNnTF 
       { \l__xframed_free_vspace_dim }
       <
       {
        \l__xframed_firsttitle_htdp_dim + \l__xframed_foot_htdp_dim      
        +
        \xframed__get_length:n { line-width-title }
        +
        \xframed__get_length:n { line-width-foot }
       }
       {%title+foot to big for current page
        \vfill\eject
        \dim_set_eq:NN \l__xframed_free_vspace_dim \vsize
        \xframed__coffin_output_aux:
       }
       {
        %go message needed
       }
    }
 }
 
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%               Starting splitting algorithm -- first part               %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_new:Npn \xframmed__pagebreak:
 {
  \vfill\eject
  \dim_set_eq:NN \l__xframed_free_vspace_dim \vsize
%  \xframed__output_and_draw_aux_i:
 }


\cs_new:Npn \xframed__output_and_draw_aux:
 {
  \group_begin:
    \tl_set_eq:NN \l__xframed_temptitle_tl \l__xframed_firsttitle_tl
    \tl_set_eq:NN \l__xframed_tempfoot_tl  \l__xframed_foot_tl
    \xframed__title:
    \xframed__foot:
    \xframed__dimtest_title_foot:
    %calculate the maximum height of first frame:
    \dim_set:Nn \l__xframed_splitheight_dim { \l__xframed_free_vspace_dim }
    \clist_map_inline:nn
      {
       extra-skip-above , line-width-top , inner-top-margin,
       split-skip-bottom, line-width-title , line-width-foot ,
       title-height , foot-height
      }
      {
       \xframed__length_sub:Nn \l__xframed_splitheight_dim  { ##1 }
      }
    \bool_if:NT \l__xframed_draweveryline_bool 
     {
      \bool_if:NT \l__xframed_bottomline_bool
       {
        \xframed__length_sub:Nn 
           \l__xframed_splitheight_dim { line-width-bottom }
       }
     }     
    \xframed__msg_log:n 
      { 
       Maximum~height~of~first~frame:\\ 
       \dim_eval:n { \l__xframed_splitheight_dim }\ =\
       \xframed_convert:n{ \l__xframed_splitheight_dim } 
      }
    \xframed_splitting_algorithm:
    \group_begin:  
      \xframed_setup_firstframe:
      \coffin_set_eq:NN \l__xframed_main_coffin \l__xframed_temp_coffin
      \vcoffin_set:Nnn \l__xframed_main_coffin
         { \l__xframed_coffin_width_dim }
         {
          \xframed__offinterlineskip:
          \skip_vertical:n { \xframed__get_length:n { inner-top-margin } }
          \vbox_unpack_clear:N \l__xframed_main_coffin
          \skip_vertical:n { \xframed__get_length:n { inner-bottom-margin } }
         }
      \xframed_draw_frame:
    \group_end:
    \xframmed__pagebreak:
    \xframed__output_and_draw_aux_i:  
  \group_end:
 }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%              Starting splitting algorithm -- middle part               %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cs_new:Npn \xframed__output_and_draw_aux_i:  
 {
  \dim_compare:nNnTF { \box_wd:N \l__xframed_main_coffin } < { 1pt }
  %\box_if_empty:NTF \l__xframed_main_coffin
   {
     %WARNING
   }
   {
    \tl_set_eq:NN \l__xframed_temptitle_tl \l__xframed_title_tl
    \tl_set_eq:NN \l__xframed_tempfoot_tl  \l__xframed_lastfoot_tl
    \xframed__title:
    \xframed__foot:
    %calculate the maximum height of current / maybe last frame:
    \dim_set:Nn \l__xframed_splitheight_dim { \l__xframed_free_vspace_dim }
    \clist_map_inline:nn
      {
       split-skip-top , inner-bottom-margin ,
       line-width-title , line-width-foot , line-width-bottom
      }
      {
       \xframed__length_sub:Nn \l__xframed_splitheight_dim { ##1 }
      }
    \bool_if:NT \l__xframed_draweveryline_bool 
     {
      \bool_if:NT \l__xframed_topline_bool
       {
        \xframed__length_sub:Nn \l__xframed_splitheight_dim { line-width-top }
       }
     }
    \dim_compare:nNnTF 
     { \box_ht:N \l__xframed_main_coffin + \box_dp:N \l__xframed_main_coffin }
     < 
     { \l__xframed_splitheight_dim }
     {%last frame
       \group_begin:  
         \xframed_setup_lastframe:
         \vcoffin_set:Nnn \l__xframed_main_coffin
            { \l__xframed_coffin_width_dim }
            {
             \xframed__offinterlineskip:
             \skip_vertical:n { \xframed__get_length:n { split-skip-top } }
             \vbox_unpack_clear:N \l__xframed_main_coffin
             \skip_vertical:n { \xframed__get_length:n { inner-bottom-margin } }
            }
         \xframed_draw_frame:
       \group_end:
     }
     {%we have a middle part
      \tl_set_eq:NN \l__xframed_temptitle_tl \l__xframed_title_tl
      \tl_set_eq:NN \l__xframed_tempfoot_tl  \l__xframed_foot_tl
      \xframed__title:
      \xframed__foot:
      \dim_set:Nn \l__xframed_splitheight_dim { \l__xframed_free_vspace_dim }
      \clist_map_inline:nn
        {
         split-skip-top , split-skip-bottom, line-width-title ,
         line-width-foot , title-height , foot-height
        }
        {
         \xframed__length_sub:Nn \l__xframed_splitheight_dim { ##1 }
        }
      \bool_if:NT \l__xframed_draweveryline_bool 
       {
        \bool_if:NT \l__xframed_topline_bool
         {
          \xframed__length_sub:Nn 
             \l__xframed_splitheight_dim { line-width-top }
         }
        \bool_if:NT \l__xframed_bottomline_bool
         {
          \xframed__length_sub:Nn 
              \l__xframed_splitheight_dim { line-width-bottom }
         }
       }
      \xframed__msg_log:n 
        { 
         Maximum~height~of~middle~frame:\\ 
         \dim_eval:n { \l__xframed_splitheight_dim }\ =\
         \xframed_convert:n{ \l__xframed_splitheight_dim } 
        }
      \xframed_splitting_algorithm:
      \group_begin:  
        \xframed_setup_middleframe:
        \coffin_set_eq:NN \l__xframed_main_coffin \l__xframed_temp_coffin
        \vcoffin_set:Nnn \l__xframed_main_coffin
           { \l__xframed_coffin_width_dim }
           {
            \xframed__offinterlineskip:
            \skip_vertical:n { \xframed__get_length:n { split-skip-top } }
            \vbox_unpack_clear:N \l__xframed_main_coffin
            \skip_vertical:n { \xframed__get_length:n { split-skip-bottom } }
           }
        \xframed_draw_frame:
      \group_end:
      \xframmed__pagebreak:
      \xframed__output_and_draw_aux_i:             
     }    
   }
 }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%========================================================================%%%%
%%%%                          Splitting with loop                           %%%%
%%%%========================================================================%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_new:Npn \xframed_splitting_algorithm:
 {
  \xframed_local_boxdim:
  \xframed_ignore_vbadness:
  \vbox_set_split_to_ht:NNn 
      \l__xframed_tmpb_box
      \l__xframed_main_coffin
    { \l__xframed_splitheight_dim - \tex_pageshrink:D }
  \vbox_set:Nn \l__xframed_tmpb_box 
        { \vbox_unpack_clear:N \l__xframed_tmpb_box }
  \dim_set:Nn \l__xframed_tmpa_dim      
    {
     \box_ht:N \l__xframed_tmpb_box + \box_dp:N \l__xframed_tmpb_box
    }
  \dim_compare:nNnTF { \l__xframed_splitheight_dim } > { \l__xframed_tmpa_dim  }
   {%splitting successful
    \xframed__msg_log:n { Splitting~successful }
   }
   {
    \xframed__msg_log:n { Splitting~not~successful }
    \int_set:Nn \l_tmpa_int { 0 }
    \dim_set:Nn \l_tmpa_dim { 0pt }
    \dim_while_do:nNn { \l__xframed_tmpa_dim } < { \l__xframed_splitheight_dim }
     {
      \coffin_set_eq:NN \l__xframed_main_coffin \l__xframed_save_coffin
      \int_incr:N \l_tmpa_int
      \dim_add:Nn \l_tmpa_dim { 8 pt } 
      \xframed_ignore_vbadness:
      \vbox_set_split_to_ht:NNn 
          \l__xframed_tmpb_box
          \l__xframed_main_coffin
        { \l__xframed_splitheight_dim - \tex_pageshrink:D - \l_tmpa_dim }
      \vbox_set:Nn \l__xframed_tmpb_box 
            { \vbox_unpack_clear:N \l__xframed_tmpb_box }
      \dim_set:Nn \l__xframed_tmpa_dim      
        {
         \box_ht:N \l__xframed_tmpb_box + \box_dp:N \l__xframed_tmpb_box
        }
      \xframed__msg_log:n { Splitting~Try~\int_use:N \l_tmpa_int }    
      \int_compare:nNnT { \l_tmpa_int } > { 50 }
        {
         \xframed__msg_log:n { too~much~loops }
         \dim_set:Nn \l__xframed_tmpa_dim  { 0pt }
        }
     }
   }
   \vcoffin_set:Nnn
            \l__xframed_temp_coffin
          { \l__xframed_coffin_width_dim }
          { \vbox_unpack_clear:N \l__xframed_tmpb_box }
   \xframed__coffin_restructure:N \l__xframed_temp_coffin
   \xframed__coffin_restructure:N \l__xframed_main_coffin
   \xframed__msg_log:n 
     { 
      height~of~split~frame:\\ 
      \dim_eval:n { \l__xframed_tmpa_dim }\ =\
       \xframed_convert:n{ \l__xframed_tmpa_dim }
     }     
 }


\tex_endinput:D
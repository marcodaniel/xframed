%%=======================================================%%
%%=======================================================%%
%% xframed-funct.def                                     %%
%%                                                       %%
%% file to define helper functions                       %%
%% file is part of the package xframed                   %%
%%                                                       %%
%% Author's name: Marco Daniel                           %%
%% License type: lppl                                    %%
%%                                                       %%
%%  Copyright (c) 2013 Marco Daniel                      %%
%%                                                       %%
%%  This package may be distributed under the terms      %%
%%  of the LaTeX Project Public License, as described    %%
%%  in lppl.txt in the base LaTeX distribution.Either    %%
%%  version 1.0 or, at your option, any later version.   %%
%%=======================================================%%
%%=======================================================%%

\cs_new:Npn \xframed__coffin_restructure:N #1
 {
  \vcoffin_set:Nnn #1
                  { \coffin_wd:N \l__xframed_main_coffin } 
                  { 
                    \box_use_clear:N #1
                  } 
 }

\cs_new:Npn \xframed__prop_set:Nnn #1 #2 #3
 {
  \prop_put:Nnx #1 { #2 } { #3 }
 }
\cs_generate_variant:Nn \xframed__prop_set:Nnn { cnn }

\cs_new:Npn \xframed__prop_get:nn #1 #2
 {
  \prop_get:cn { l__xframed_#1_option_prop } { #2 } 
 }

\cs_new:Npn \xframed__get_skip:n #1
 {
  \skip_eval:n 
    { 
     \prop_get:Nn \l__xframed_skip_option_prop { #1 }
     %\xframed__prop_get:nn { skip } { #1 } 
    }
 }
\cs_new:Npn \xframed__get_length:n #1
 {
  \dim_eval:n 
    { 
     \prop_get:Nn \l__xframed_length_option_prop { #1 }
%     \xframed__prop_get:nn { length } { #1 } 
    }
 }
\cs_new:Npn \xframed__get_color:n #1
 {
  \prop_get:Nn \l__xframed_color_option_prop { #1 }
%  \xframed__prop_get:nn { color } { #1 }
 }

% \xframed__test_linewidth:nnn {<bool name>}{<prop-list>}{<lenght/skip>}
\cs_new:Npn \xframed__test_linewidth:nnn #1 #2 #3
 {
  \bool_if:cF { l__xframed_ #1 _bool }
  { 
   \xframed__prop_set:cnn 
     { l__xframed_ #2 _option_prop }
     { #3 }
     { \c_zero_dim }
  }
 } 
 
%http://tex.stackexchange.com/a/112345/5239
\cs_generate_variant:Nn \tl_if_empty:nTF { f } 


%%Test developer:
\cs_new:Npn \xframed__display_coffins:N #1
 {
  \box_use:N #1
 }
\cs_new:Npn \xframed__msg_log:n #1 {}

\cs_new:Npn \xframed__developer_tools:
 {
  \bool_if:NT \l__xframed_developer_info_bool
    { 
     \cs_set:Npn \xframed__display_coffins:N ##1
       {
        \coffin_display_handles:Nn ##1 { blue!70!black }
       }
     \cs_set:Npn \xframed__msg_log:n ##1 
      { 
       \msg_log:n { xframed~developer~info~line~
                    \msg_line_number:\\\\##1
                  }
      }
    }
 }

\cs_new:Npn \egreg_convertto:nn #1 #2
 {
  \fp_eval:n { round( \dim_to_fp:n { #2 } / 1#1, 5) }~#1
 }
\cs_new:Nn \xframed__all_option_output:
 {
  \tl_set:Nn \l_tmpa_tl 
   {
    \group_begin:
    \renewcommand\arraystretch{1.25}
    \begin{longtable}{@{}lll@{}}
      \caption*{Options}\\\hline
     \endhead
      \multicolumn{3}{@{}r@{}}{\ldots}\\\hline
     \endfoot
      \hline
     \endlastfoot
   }
   \tl_put_right:Nn \l_tmpa_tl { \multicolumn{3}{@{}c@{}}{length} \\\hline }
   \tl_put_right:Nn \l_tmpa_tl 
    { 
     \prop_map_inline:Nn  \l__xframed_length_option_prop 
       { ##1 & \dim_eval:n { ##2 } & \egreg_convertto:nn{cm}{##2}  \\ } 
    }
   \tl_put_right:Nn \l_tmpa_tl 
    { \\\hline\multicolumn{3}{@{}c@{}}{skips} \\\hline }
   \tl_put_right:Nn \l_tmpa_tl 
    { 
     \prop_map_inline:Nn  \l__xframed_skip_option_prop 
      { ##1 & \skip_eval:n { ##2 } & \egreg_convertto:nn{cm}{##2} \\ } 
    }
   \tl_put_right:Nn \l_tmpa_tl 
    { \\\hline\multicolumn{3}{@{}c@{}}{color} \\\hline }
   \tl_put_right:Nn \l_tmpa_tl 
    { 
     \prop_map_inline:Nn  \l__xframed_color_option_prop 
       { ##1 &  ##2  & \color{ ##2 } ##1  \\ }
    }
   \tl_put_right:Nn \l_tmpa_tl { \end{longtable} \group_end: }
  \tl_use:N \l_tmpa_tl
 }

\cs_new:Npn \xframed__option_output:n #1
 {
  \use:c {xframed__#1_output_aux: }
 }

\cs_new:Nn \xframed__length_output_aux:
 {
  \tl_set:Nn \l_tmpa_tl 
   { 
    \group_begin:
    \renewcommand\arraystretch{1.25}
    \begin{longtable}{@{}lll@{}}
      \caption*{Length-options}\\\hline
     \endhead
      \multicolumn{3}{@{}r@{}}{\ldots}\\\hline
     \endfoot
      \hline
     \endlastfoot
   }
 \tl_put_right:Nn \l_tmpa_tl 
  { 
   \prop_map_inline:Nn  \l__xframed_length_option_prop 
    { ##1 & \dim_eval:n { ##2 } & \egreg_convertto:nn{cm}{##2}  \\ } 
  }
 \tl_put_right:Nn \l_tmpa_tl { \end{longtable} \group_end: }
 \tl_use:N \l_tmpa_tl
 }
 
\cs_new:Nn \xframed__skip_output_aux:
 {
  \tl_set:Nn \l_tmpa_tl 
   { 
    \group_begin:
    \renewcommand\arraystretch{1.25}
    \begin{longtable}{@{}lll@{}}
      \caption*{Skip~options}\\\hline
     \endhead
      \multicolumn{3}{@{}r@{}}{\ldots}\\\hline
     \endfoot
      \hline
     \endlastfoot
   }
 \tl_put_right:Nn \l_tmpa_tl 
  { 
   \prop_map_inline:Nn  \l__xframed_skip_option_prop 
    { ##1 & \skip_eval:n { ##2 } & \egreg_convertto:nn{cm}{##2}  \\ } 
  }
 \tl_put_right:Nn \l_tmpa_tl { \end{longtable} \group_end: }
 \tl_use:N \l_tmpa_tl
 }

\cs_new:Nn \xframed__color_output_aux:
 {
  \tl_set:Nn \l_tmpa_tl 
   { 
    \group_begin:
    \renewcommand\arraystretch{1.25}
    \begin{longtable}{@{}lll@{}}
      \caption*{Color~options}\\\hline
     \endhead
      \multicolumn{3}{@{}r@{}}{\ldots}\\\hline
     \endfoot
      \hline
     \endlastfoot
   }
 \tl_put_right:Nn \l_tmpa_tl 
  { 
   \prop_map_inline:Nn  \l__xframed_color_option_prop 
    { ##1 &  ##2  & \color{ ##2 } ##1  \\ } 
  }
 \tl_put_right:Nn \l_tmpa_tl { \end{longtable} \group_end: }
 \tl_use:N \l_tmpa_tl
 }

 
\cs_new:Npn \xframed__show_length:n #1
 {
  \dim_set:Nn \l_tmpa_dim { \xframed__get_length:n { #1 } }
  \dim_use:N \l_tmpa_dim
 }
\cs_new:Npn \xframed__show_skip:n #1
 {
  \skip_set:Nn \l_tmpa_skip { \xframed__get_skip:n { #1 } }
  \skip_use:N \l_tmpa_skip
 }    
%!end Developer info 
%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\cs_new:Npn \xframed__start_environment:n #1
 {
  \par
    \xframed__enought_room:n { #1 }
  \par
  \dim_compare:nNnF
    { \tex_prevdepth:D } { = } { - \c_one_thousand \c_one_pt_dim }
    {
     \int_set:Nn \l_tmpa_int
      {
       \fp_to_int:n 
         {
          %%\prevdepth as integer in scale points
          (\dim_to_fp:n { \tex_prevdepth:D } * 65536) 
          /
          %%\baselineskip as integer in scale points
          (\dim_to_fp:n { \baselineskip } * 65536) 
          + 
          \c_one
         } 
      }
     \dim_set:Nn \l_tmpa_dim 
      {
       \tex_prevdepth:D - \l_tmpa_int\baselineskip + \topskip
      }  
     \tex_kern:D \l_tmpa_dim 
    }   
 }
 
\cs_new:Npn \xframed__enought_room:n #1 
 {
  \par
  \group_begin:
    \@nobreakfalse\addpenalty\z@
  \group_end:
  \dim_set_eq:NN \l__xframed_free_vspace_dim \tex_pagegoal:D
  \dim_add:Nn \l__xframed_free_vspace_dim {  - \tex_pagetotal:D }
  \dim_set:Nn \l_tmpa_dim { #1 }
  %\xframed__msg_log:n
  \msg_log:n
    {
     xframed~info~\msg_line_number:\\\\
     \ dimension~of~the~current~page \\
     \ height~=~\dim_use:N \tex_pagegoal:D\ =
            \ \egreg_convertto:nn{cm}{\tex_pagegoal:D} \\
     \ used~=~\dim_use:N \tex_pagetotal:D\ =
            \ \egreg_convertto:nn{cm}{\tex_pagetotal:D} \\
     \ free~=~\dim_use:N \l__xframed_free_vspace_dim 
            \ \egreg_convertto:nn{cm}{\l__xframed_free_vspace_dim} \\
     \ request~=~\dim_use:N \l_tmpa_dim\ =
            \  \egreg_convertto:nn{cm}{ \l_tmpa_dim } \\      
     \ request~is~provided~by~the~option:~minimum-space
    }
 \dim_compare:nNnTF
  { \l__xframed_free_vspace_dim } { < } { \l_tmpa_dim } 
  { \newpage }{}%not enough space on current p   
 }
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\cs_new:Npn \xframed__trivlist:
 {
  \skip_set:Nn {\topsep}{ \xframed__prop_get:nn { skip }{ skip-above } }
  \parsep\parskip
  \@nmbrlistfalse
  \@trivlist
  \labelwidth\z@
  \leftmargin\z@
  \itemindent\z@
  \let\@itemlabel\@empty
  \def\makelabel##1{##1}
 }

\cs_new:Npn \endxframed__trivlist:
 {    
  \if@inlabel
    \leavevmode
    \global \@inlabelfalse
  \fi
  \if@newlist
    \@noitemerr
    \global \@newlistfalse
  \fi
  \ifhmode\unskip \par
  \else
    \@inmatherr{\end{\@currenvir}}%
  \fi
  \if@noparlist \else
    \ifdim\lastskip >\z@
      \@tempskipa\lastskip \vskip -\lastskip
      \advance\@tempskipa\parskip \advance\@tempskipa -\@outerparskip
      \vskip\@tempskipa
    \fi
    \addpenalty\@endparpenalty
    \addvspace { \xframed__get_skip:n { skip-below } }
    \@endpetrue
  \fi
 }

%
\cs_new_protected:Npn \xframed__set_list:
 {
  \xframed__trivlist:\item\relax\color_group_begin:
  \color_ensure_current:
 }


\cs_set_protected_nopar:Npn \xframed__set_endlist:
    {
     \color_group_end:
     \endxframed__trivlist:
    } 

\tex_endinput:D
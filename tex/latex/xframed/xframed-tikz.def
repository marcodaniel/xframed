%%initial~of~styles
\def\xframedsetuptikz{\pgfqkeys{/tikz/xframed}}
\xframedsetuptikz{
%main
 bg/.style=
      { 
       fill = { \xframed__get_color:n { bg-color } },
       rounded~corners= { 0pt }
      },
%title
 title~bg/.style=
      {
       draw=none, 
       fill= \xframed__get_color:n { title-bg-color },
       rounded~corners= { 0pt } 
      }, 
 title~rule/.style=
      { 
       draw= \xframed__get_color:n { title-line-color },
       line~width= \xframed__get_length:n { line-width-title },
      },
%foot
 foot~bg/.style=
      { 
       fill= \xframed__get_color:n { foot-bg-color },
       rounded~corners= { 0pt } 
      }, 
 foot~rule/.style=
      { 
       draw = \xframed__get_color:n { foot-line-color },
       line~width=\xframed__get_length:n { line-width-foot }
      },
%%%%%%%title
%%%%%% left~line/.style={line~width=2pt},
%%%%%%%arc
 inner~arc/.style={rounded~corners=\xframed__get_length:n { inner-arc }},
 outer~arc/.style={rounded~corners=\xframed__get_length:n { outer-arc }},
%frame
 right~line/.style=
       { 
        draw = \xframed__get_color:n { line-color-right } ,
        line~width= { \xframed__get_length:n { line-width-right } },
       },
 left~line/.style=
      { 
       draw = \xframed__get_color:n { line-color-left } ,
       line~width={ \xframed__get_length:n { line-width-left } },
      },
 top~line/.style=
     {
      draw = \xframed__get_color:n { line-color-top } ,
      line~width={ \xframed__get_length:n { line-width-top } },
     },
 bottom~line/.style=
     {
      draw = \xframed__get_color:n { line-color-bottom } ,
      line~width={ \xframed__get_length:n { line-width-bottom } },
     },
 line~color/.style=
     {
      draw = none ,
      fill = \xframed__get_color:n { line-color-left },
      rounded~corners= { \xframed__get_length:n { outer-arc } },
     },minimum-space
%subtitle
 subtitle~bg/.style={fill=red},
 subtitle~above~rule/.style={draw=black,line~width=2pt},
 subtitle~below~rule/.style={draw=black,line~width=2pt},
 subtitle~rule/.style={subtitle~above~rule=#1,subtitle~below~rule=#1},
%clear definition 
}


\cs_new:Nn \xframed__draw_tikz_frame:
 {
  \begin{tikzpicture}[remember~picture]  
   %%Inner part -- defines node xframed-inner
   \xframed__tikz_innerpart:
   %%title part -- defines node xframed-title
   \xframed__tikz_titlepart:
   %%foot part -- defines node xframed-foot  
   \xframed__tikz_footpart:
   %%%%%%%%%
   %Outer part -- defines node xframed-outer
   \xframed__tikz_drawframe:    
  %\pgfnodealias{xframed-outer}{xframed-inner}
   %use the correct bounding box
   \pgfresetboundingbox\useasboundingbox%
     ($(xframed-outer.south~west)+(-\xframed__get_length:n { left-margin },0)$) 
       rectangle
     ($(xframed-outer.north~east)+( \xframed__get_length:n { right-margin },0)
       +(0,\xframed__get_length:n { extra-skip-above })$) ;
      %Show development tools
  \xframed__nodepoints_development:
  \end{tikzpicture} 
%%%%  \xframed__all_option_output:
 }
 
\cs_new:Nn \xframed__tikz_innerpart:
 {
  \begin{scope}
    \tikzset{every~node/.style={inner~sep=0pt,outer~sep=0pt,}}      
    \node[](xframed-inner)
      {
       \hbox:n{} \skip_horizontal:n { \xframed__get_length:n { inner-left-margin } }
       \xframed__display_coffins:N \l__xframed_main_coffin 
       \skip_horizontal:n { \xframed__get_length:n { inner-right-margin } } \hbox:n{} 
      };        
  \end{scope}
 }
 
\cs_new:Nn \xframed__tikz_titlepart:
 {
  \tl_if_blank:VTF \l__xframed_firsttitle_tl
    {
     \pgfnodealias{xframed-title}{xframed-inner} 
    } 
    {
    \begin{scope}
      \tikzset{every~node/.style={inner~sep=0pt,outer~sep=0pt,}}
      \node[anchor=south,
       yshift= \xframed__get_length:n { line-width-title } ] (xframed-title) at (xframed-inner.north)
        {
         \hbox:n{} \skip_horizontal:n { \xframed__get_length:n { inner-left-margin } }
         \xframed__display_coffins:N \l__xframed_title_coffin 
         \skip_horizontal:n { \xframed__get_length:n { inner-right-margin } } \hbox:n{} 
        };
        
    \end{scope}
    } 
 } 
\cs_new:Nn \xframed__tikz_footpart:
 {
  \tl_if_blank:VTF \l__xframed_lastfoot_tl
    {
     \pgfnodealias{xframed-foot}{xframed-inner}
    }
    {
     \begin{scope}
       \tikzset{every~node/.style={inner~sep=0pt,outer~sep=0pt,}}     
       \node[anchor=north,
        yshift= {-\xframed__get_length:n { line-width-foot }}, 
        ] (xframed-foot) at (xframed-inner.south)
         {
          \skip_horizontal:n { \xframed__get_length:n { inner-left-margin } }
          \xframed__display_coffins:N \l__xframed_foot_coffin
          \skip_horizontal:n { \xframed__get_length:n { inner-right-margin } } \hbox:n{} 
         };
     \end{scope}
    } 
 } 

\cs_new:Nn \xframed__tikz_drawframe:
 {
  \begin{scope}[on~background~layer]
    %%Draw the main frame
    \coordinate (fxx) at %fxx=left bottom
             ($(xframed-foot.south~west)+(-\xframed__get_length:n { line-width-left },-\xframed__get_length:n { line-width-bottom })$); 
    \coordinate (fyy) at %fyy=right top
             ($(xframed-title.north~east)+(\xframed__get_length:n { line-width-right },\xframed__get_length:n { line-width-top })$);
    \tikzset{every~node/.style={inner~sep=0pt,outer~sep=0pt,}}      
    \node[anchor=south,
           yshift= -\xframed__get_length:n { line-width-bottom },
           xshift= .5*\xframed__get_length:n { line-width-right }-.5*\xframed__get_length:n { line-width-left }, ] 
         (xframed-outer) at (xframed-foot.south)
         {\tikz\path(fxx) rectangle (fyy);};
    \clip[xframed/outer~arc](xframed-outer.south~west) rectangle (xframed-outer.north~east);
    \xframed__tikz_drawframe_lines:
    \xframed__tikz_drawframe_titlefoot:
  \end{scope}
 }
\cs_new:Nn \xframed__tikz_drawframe_lines:
 {
  %left line
    \path[fill = \xframed__get_color:n { line-color-left }] 
     (xframed-outer.north~west) --  (xframed-outer.south~west) -- (xframed-inner.center) --cycle;
   %right line
    \path[fill = \xframed__get_color:n { line-color-right }] 
     (xframed-outer.north~east) --  (xframed-outer.south~east) -- (xframed-inner.center) --cycle;
  %top line
    \path[fill = \xframed__get_color:n { line-color-top }] 
     (xframed-outer.north~east) --  (xframed-outer.north~west) -- (xframed-inner.center) --cycle;
   %bottom line
    \path[fill = \xframed__get_color:n { line-color-bottom }] 
     (xframed-outer.south~east) --  (xframed-outer.south~west) -- (xframed-inner.center) --cycle;   
 } 

\cs_new:Nn \xframed__tikz_drawframe_titlefoot:
 {
  \begin{scope}
   %inner frame
     \clip[xframed/inner~arc] (xframed-foot.south~west) rectangle (xframed-title.north~east);
     \path[xframed/bg] (xframed-foot.south~west) rectangle (xframed-title.north~east);
   %draw title componente (1) title (2) foot rule:
     \tl_if_blank:VF \l__xframed_firsttitle_tl
       {
        \path[xframed/title~bg] (xframed-title.south~west) rectangle (xframed-title.north~east);
        \bool_if:NT \l__xframed_footline_bool
         {
          \path[xframed/title~rule]    
                 ([yshift= .5*\xframed__get_length:n { line-width-foot }]xframed-inner.north~west) -- 
                 ([yshift= .5*\xframed__get_length:n { line-width-foot }]xframed-inner.north~east);  
         }
       }
   %draw foot componente (1) foot (2) foot rule:
     \tl_if_blank:VF \l__xframed_lastfoot_tl
       {
        \path[xframed/foot~bg] (xframed-foot.south~west) rectangle (xframed-foot.north~east);
        \bool_if:NT \l__xframed_footline_bool
         {
          \path[xframed/foot~rule]    
                 ([yshift= -.5*\xframed__get_length:n { line-width-foot }]xframed-inner.south~west) -- 
                 ([yshift= -.5*\xframed__get_length:n { line-width-foot }]xframed-inner.south~east);  
         }
       }
  \end{scope}    
 }


%%%%%%%%%%
%DEVELOPER INFO
%%%%%%%%%%
\cs_new:Nn \xframed__nodepoints_development:
 {
  \bool_if:NT \l__xframed_developer_info_bool
   {
    \begin{scope}
     %%%%%Inner nodes
     \xframed__nodepoints_inner_development:
     %%%%%title nodes
     \xframed__nodepoints_title_development:
     %%%%%foot nodes
     \xframed__nodepoints_foot_development:
     %%%%%Outer nodes  
     \xframed__nodepoints_outer_development:
     %%%%%length     
     \xframed__outerlength_development:
    \end{scope}
   }
 }
 
 \cs_new:Nn \xframed__nodepoints_inner_development:
  {
   \fill[red!70!black] (xframed-inner.north~west) circle (2pt) 
      node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-inner.north~west}; 
   \fill[red!70!black] (xframed-inner.north~east) circle (2pt) 
      node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-inner.north~east}; 
   \fill[red!70!black] (xframed-inner.south~west) circle (2pt) 
      node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-inner.south~west}; 
   \fill[red!70!black] (xframed-inner.south~east) circle (2pt) 
      node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-inner.south~east};
   \fill[red!70!black] (xframed-inner.center) circle (2pt) 
      node[draw,rectangle,fill=yellow,above=0.5cm,font=\footnotesize\ttfamily] {xframed-inner.center};
  }

 \cs_new:Nn \xframed__nodepoints_outer_development:
  {
   \fill[blue!70!black] (xframed-outer.north~west) circle (2pt) 
      node[above=0.75cm,font=\footnotesize\ttfamily] {xframed-outer.north~west}; 
   \fill[blue!70!black] (xframed-outer.north~east) circle (2pt) 
      node[above=0.75cm,font=\footnotesize\ttfamily] {xframed-outer.north~east}; 
   \fill[blue!70!black] (xframed-outer.south~west) circle (2pt) 
      node[below=0.75cm,font=\footnotesize\ttfamily] {xframed-outer.south~west}; 
   \fill[blue!70!black] (xframed-outer.south~east) circle (2pt) 
      node[below=0.75cm,font=\footnotesize\ttfamily] {xframed-outer.south~east};
   \fill[blue!70!black] (xframed-outer.center) circle (2pt) 
      node[draw,rectangle,fill=yellow,below=0.5cm,font=\footnotesize\ttfamily] {xframed-outer.center};
  }

 \cs_new:Nn \xframed__nodepoints_title_development:
  {
   \tl_if_blank:VF \l__xframed_firsttitle_tl
     {
       \fill[green!70!black] (xframed-title.north~west) circle (2pt) 
          node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-title.north~west}; 
       \fill[green!70!black] (xframed-title.north~east) circle (2pt) 
          node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-title.north~east}; 
       \fill[green!70!black] (xframed-title.south~west) circle (2pt) 
          node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-title.south~west}; 
       \fill[green!70!black] (xframed-title.south~east) circle (2pt) 
          node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-title.south~east};
       \fill[green!70!black] (xframed-title.center) circle (2pt) 
          node[draw,rectangle,fill=yellow,above=0.5cm,font=\footnotesize\ttfamily] {xframed-title.center};
     }
  }

 \cs_new:Nn \xframed__nodepoints_foot_development:
  {
   \tl_if_blank:VF \l__xframed_lastfoot_tl
    {
      \fill[green!70!black] (xframed-foot.north~west) circle (2pt) 
         node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-foot.north~west}; 
      \fill[green!70!black] (xframed-foot.north~east) circle (2pt) 
         node[above=0.5cm,font=\footnotesize\ttfamily] {xframed-foot.north~east}; 
      \fill[green!70!black] (xframed-foot.south~west) circle (2pt) 
         node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-foot.south~west}; 
      \fill[green!70!black] (xframed-foot.south~east) circle (2pt) 
         node[below=0.5cm,font=\footnotesize\ttfamily] {xframed-foot.south~east};
      \fill[green!70!black] (xframed-foot.center) circle (2pt) 
         node[draw,rectangle,fill=yellow,above=0.5cm,font=\footnotesize\ttfamily] {xframed-foot.center};
    } 
  }
 
\cs_new:Nn \xframed__outerlength_development:
 {
  \draw[latex-latex] (xframed-outer.east)  --++ ( \xframed__get_length:n { right-margin },0) ;
  \draw[latex-latex] (xframed-outer.west)  --++ (-\xframed__get_length:n { left-margin }, 0) ;
  \draw[latex-latex] (xframed-outer.north) --++ ( 0 , \xframed__get_skip:n { skip-above }  ) ;
  \draw[latex-latex] (xframed-outer.south)  --++ ( 0 , -\xframed__get_skip:n { skip-below } ) ;
 }

 
